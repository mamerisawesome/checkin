<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>

<style>
* {font-family: 'Arial';}
table {border: 1px solid black;}
td {width: 200px;}
tr:hover {background: #EEE;}
input {width: 300px;}
button.delete {
	cursor: pointer;
	float: right;
}
textarea {
	width: 500px;
	height: 300px;
}
</style>

<h1>Checkin</h1>

<p>
	Make sure your project starts with #. Otherwise, the activity entry is treated as non-work (break, lunch, etc.)
</p>

<div>
	<h3>Input</h3>
	<input id="project" placeholder="#project / out / break / lunch / whatever" />
	<input id="tasks" placeholder="stuff, i, did (optional)" />
	<span>(Press enter)</span>
</div>

<div>
	<h3>Entries <button id="clear">Clear</button></h3>
	<table id="entries"></table>
</div>

<div>
	<h3>Output</h3>
	<textarea id="output"></textarea>
</div>

<script>

var entries = JSON.parse(localStorage.getItem('entries')) || [];
updateList();
updateOutput();

function updateList(){
	var entryList = $('#entries');
	entryList.children().remove();
	for (var i in entries){
		var e = entries[i];
		entryList.append('<tr>\
			<td>' + e.project + '</td>\
			<td>' + e.tasks + '</td>\
			<td>' + new Date(e.startTime).toString().split(' ')[4] + '</td>\
			<td>\
				<button class="delete" timestamp="' + e.startTime + '"">X</button>\
			</td>\
			</tr>');
	}
}

function updateOutput(){
	var lines = ['checkin'];
	for (var i in entries){
		if (i == entries.length - 1) break;
		var e = entries[i];
		if (!e.project.startsWith('#')) continue;
		var duration = ((entries[+i+1].startTime - e.startTime) / 360000).toFixed(2);
		var line = ['-', duration, 'hrs', e.project, e.tasks].join(' ');
		lines.push(line);
	}
	var output = lines.join('\n');
	$('#output').val(output);
}

function save(){
	localStorage.entries = JSON.stringify(entries);
	updateList();
	updateOutput();
}

function addEntry(){
	var project = $('#project');
	var tasks = $('#tasks');
	entries.push({
		project: project.val(),
		tasks: tasks.val(),
		startTime: Date.now()
	});
	project.val(null);
	tasks.val(null);
	save();
}

$(document).on('click', '.delete', (e) => {
	var timestamp = e.target.getAttribute('timestamp');
	entries = entries.filter(e => e.startTime != timestamp);
	save();
});

$('input').keypress(e => {
    if(e.which == 13){
        addEntry();
        $('#project').focus();
    }
});

$('#clear').click(() => {
	entries = [];
	save();
})

</script>
